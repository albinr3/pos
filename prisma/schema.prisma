// Prisma schema for MOVOPos - Multi-tenant POS System
// Money is stored as integer cents (RD$ 1.00 => 100)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  CAJERO
  ALMACEN
}

enum SaleType {
  CONTADO
  CREDITO
}

enum AROpenStatus {
  PENDIENTE
  PARCIAL
  PAGADA
}

enum PaymentMethod {
  EFECTIVO
  TRANSFERENCIA
  TARJETA
  OTRO
  DIVIDIR_PAGO // Solo para UI, no se guarda en BD
}

enum AuditAction {
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  SALE_CREATED
  SALE_CANCELLED
  SALE_EDITED
  PAYMENT_CREATED
  PAYMENT_CANCELLED
  PRICE_OVERRIDE
  PRODUCT_CREATED
  PRODUCT_EDITED
  PRODUCT_DELETED
  STOCK_ADJUSTED
  PERMISSION_CHANGED
  SETTINGS_CHANGED
  USER_CREATED
  USER_DELETED
  UNAUTHORIZED_ACCESS
  USER_UPDATED
  USER_DEACTIVATED
  CATEGORY_CREATED
  CATEGORY_EDITED
  CATEGORY_DELETED
  CUSTOMER_CREATED
  CUSTOMER_EDITED
  CUSTOMER_DELETED
  SUPPLIER_CREATED
  SUPPLIER_EDITED
  SUPPLIER_DELETED
  PURCHASE_CREATED
  PURCHASE_EDITED
  PURCHASE_CANCELLED
  RETURN_CREATED
  RETURN_CANCELLED
  QUOTE_CREATED
  QUOTE_EDITED
  QUOTE_DELETED
  OPERATING_EXPENSE_CREATED
  OPERATING_EXPENSE_EDITED
  OPERATING_EXPENSE_DELETED
  BACKUP_CREATED
  BACKUP_DELETED
  BACKUP_RESTORED
  BACKUP_DOWNLOADED
  // Billing actions
  BILLING_SUBSCRIPTION_CREATED
  BILLING_SUBSCRIPTION_UPDATED
  BILLING_PAYMENT_CREATED
  BILLING_PAYMENT_APPROVED
  BILLING_PAYMENT_REJECTED
  BILLING_PROOF_UPLOADED
  BILLING_STATUS_CHANGED
  BILLING_CURRENCY_CHANGED
}

// ==========================================
// BILLING ENUMS
// ==========================================

enum BillingStatus {
  TRIALING  // En período de prueba
  ACTIVE    // Suscripción activa con pago válido
  GRACE     // Período de gracia (3 días después de vencimiento)
  BLOCKED   // Bloqueado por falta de pago
  CANCELED  // Cancelado por el usuario
}

enum BillingCurrency {
  DOP // Pesos dominicanos
  USD // Dólares estadounidenses
}

enum BillingProvider {
  MANUAL // Transferencia bancaria
  LEMON  // Lemon Squeezy (tarjeta)
}

enum BillingPaymentStatus {
  PENDING  // Esperando verificación (transferencia)
  PAID     // Pagado y verificado
  FAILED   // Falló el pago (tarjeta)
  REJECTED // Rechazado (comprobante inválido)
}

enum ManualVerificationStatus {
  NONE     // No aplica (pago con tarjeta)
  PENDING  // Esperando verificación
  APPROVED // Comprobante aprobado
  REJECTED // Comprobante rechazado
}

enum UnitType {
  UNIDAD // Piezas (default) - solo enteros
  KG     // Kilogramos
  LIBRA  // Libras
  GRAMO  // Gramos
  LITRO  // Litros
  ML     // Mililitros
  GALON  // Galones
  METRO  // Metros
  CM     // Centímetros
  PIE    // Pies
}

// ==========================================
// ACCOUNT (Tenant/Cuenta Principal)
// ==========================================
// Representa un negocio/empresa. Todos los datos están aislados por Account.
model Account {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String  // Nombre del negocio
  clerkUserId String  @unique // ID del usuario Clerk que es dueño

  // Relaciones - todos los datos del tenant
  users            User[]
  companySettings  CompanySettings?
  customers        Customer[]
  suppliers        Supplier[]
  categories       Category[]
  products         Product[]
  sales            Sale[]
  purchases        Purchase[]
  operatingExpenses OperatingExpense[]
  returns          Return[]
  quotes           Quote[]
  auditLogs        AuditLog[]
  invoiceSequences InvoiceSequence[]
  returnSequence   ReturnSequence?
  quoteSequence    QuoteSequence?

  // Billing
  billingSubscription BillingSubscription?
  billingProfile      BillingProfile?
  billingNotifications BillingNotification[]

  @@index([clerkUserId])
}

// ==========================================
// USER (Subcuenta/Operador)
// ==========================================
// Representa un usuario/empleado dentro de un Account.
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relación con Account (tenant)
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  name         String
  username     String   // Único dentro del account
  passwordHash String   // Requerido para autenticación de subcuenta
  email        String?  // Email opcional
  role         UserRole @default(CAJERO)

  // Si es el dueño/creador del account (admin principal)
  isOwner Boolean @default(false)

  // Autenticación por WhatsApp (legacy, puede ser removido)
  whatsappNumber    String?   // Número de WhatsApp en formato E.164
  whatsappVerifiedAt DateTime? // Fecha de verificación del número

  // Granular permissions
  canOverridePrice  Boolean @default(false)
  canCancelSales    Boolean @default(false)
  canCancelReturns  Boolean @default(false)
  canCancelPayments Boolean @default(false)
  canEditSales      Boolean @default(false)
  canEditProducts   Boolean @default(false)
  canChangeSaleType Boolean @default(false)
  canSellWithoutStock Boolean @default(false)
  canManageBackups  Boolean @default(false)
  canViewProductCosts Boolean @default(false)
  canViewProfitReport Boolean @default(false)

  isActive Boolean @default(true)

  // Relaciones
  sales              Sale[]
  payments           Payment[]
  cancelledPayments  Payment[]          @relation("CancelledPayments")
  purchases          Purchase[]
  cancelledPurchases Purchase[]         @relation("CancelledPurchases")
  operatingExpenses  OperatingExpense[]
  cancelledSales     Sale[]             @relation("CancelledSales")
  returns            Return[]
  cancelledReturns   Return[]           @relation("CancelledReturns")
  quotes             Quote[]
  whatsappOtps       WhatsappOtp[]
  auditLogs          AuditLog[]

  // Username único dentro del mismo account
  @@unique([accountId, username])
  @@index([accountId])
  @@index([whatsappNumber])
  @@index([email])
}

// ==========================================
// COMPANY SETTINGS
// ==========================================
model CompanySettings {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relación con Account
  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  name    String
  phone   String
  address String

  logoUrl String?

  allowNegativeStock Boolean @default(false)
  itbisRateBp Int @default(1800)

  barcodeLabelSize  String @default("4x2")
  shippingLabelSize String @default("4x6")

  @@index([accountId])
}

// ==========================================
// SEQUENCES (por Account)
// ==========================================
model InvoiceSequence {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  series     String @default("A")
  lastNumber Int    @default(0)

  @@unique([accountId, series])
  @@index([accountId])
}

model ReturnSequence {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  lastNumber Int @default(0)

  @@index([accountId])
}

model QuoteSequence {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  lastNumber Int @default(0)

  @@index([accountId])
}

// ==========================================
// CUSTOMER
// ==========================================
model Customer {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  name     String
  phone    String?
  address  String?
  cedula   String?
  province String?

  isGeneric Boolean @default(false)
  isActive  Boolean @default(true)

  sales   Sale[]
  arItems AccountReceivable[]
  quotes  Quote[]

  @@index([accountId])
  @@index([accountId, name])
  @@index([accountId, isGeneric])
}

// ==========================================
// SUPPLIER
// ==========================================
model Supplier {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  name        String
  contactName String?
  phone       String?
  email       String?
  address     String?
  notes       String?

  discountPercentBp Int @default(0)

  isActive Boolean @default(true)

  products Product[]

  @@index([accountId])
  @@index([accountId, name])
}

// ==========================================
// CATEGORY
// ==========================================
model Category {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  name        String
  description String?
  isActive    Boolean @default(true)

  products Product[]

  // Nombre único dentro del account
  @@unique([accountId, name])
  @@index([accountId])
  @@index([accountId, isActive])
}

// ==========================================
// PRODUCT
// ==========================================
model Product {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  productId Int @default(autoincrement())

  name String

  sku String?

  reference String?

  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  priceCents Int
  costCents  Int

  itbisRateBp Int @default(1800)

  purchaseUnit UnitType @default(UNIDAD)
  saleUnit     UnitType @default(UNIDAD)
  stock        Decimal  @default(0) @db.Decimal(10, 3)
  minStock     Decimal  @default(0) @db.Decimal(10, 3)

  isActive Boolean @default(true)

  imageUrls String[] @default([])

  saleItems     SaleItem[]
  purchaseItems PurchaseItem[]
  returnItems   ReturnItem[]
  quoteItems    QuoteItem[]

  // productId único dentro del account
  @@unique([accountId, productId])
  // SKU unico por cuenta cuando existe (se aplica con indice unico parcial en migracion SQL)
  @@index([accountId, sku])
  @@index([accountId])
  @@index([accountId, name])
  @@index([accountId, reference])
  @@index([supplierId])
  @@index([categoryId])
  @@index([accountId, stock])
}

// ==========================================
// SALE
// ==========================================
model Sale {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  invoiceSeries String @default("A")
  invoiceNumber Int
  invoiceCode   String // e.g. A-00001

  soldAt DateTime @default(now())

  type SaleType

  paymentMethod PaymentMethod?

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  subtotalCents Int
  itbisCents    Int
  shippingCents Int @default(0)
  totalCents    Int

  notes String?

  cancelledAt   DateTime?
  cancelledBy   String?
  cancelledUser User?     @relation("CancelledSales", fields: [cancelledBy], references: [id])

  items    SaleItem[]
  payments SalePayment[]
  ar       AccountReceivable?
  returns  Return[]

  // invoiceCode único dentro del account
  @@unique([accountId, invoiceCode])
  @@index([accountId])
  @@index([accountId, soldAt])
  @@index([customerId])
  @@index([cancelledAt])
  @@index([invoiceCode])
}

model SaleItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  qty Decimal @db.Decimal(10, 3)

  unitPriceCents     Int
  wasPriceOverridden Boolean @default(false)

  lineTotalCents Int

  returnItems ReturnItem[]
}

model SalePayment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  method      PaymentMethod
  amountCents Int

  @@index([saleId])
}

// ==========================================
// ACCOUNTS RECEIVABLE
// ==========================================
model AccountReceivable {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  saleId String @unique
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  totalCents   Int
  balanceCents Int
  status       AROpenStatus @default(PENDIENTE)

  payments Payment[]

  @@index([status])
  @@index([customerId])
}

model Payment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  arId String
  ar   AccountReceivable @relation(fields: [arId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  paidAt      DateTime      @default(now())
  amountCents Int
  method      PaymentMethod @default(EFECTIVO)
  note        String?

  cancelledAt   DateTime?
  cancelledBy   String?
  cancelledUser User?     @relation("CancelledPayments", fields: [cancelledBy], references: [id])

  @@index([paidAt])
  @@index([cancelledAt])
}

// ==========================================
// AUDIT LOG
// ==========================================
model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  accountId String
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userEmail    String?
  userUsername String?

  action       AuditAction
  resourceType String?
  resourceId   String?
  details      Json?
  oldValue     Json?
  newValue     Json?
  ipAddress    String?
  userAgent    String?

  @@index([accountId, createdAt])
  @@index([userId, createdAt])
  @@index([action, createdAt])
}

// ==========================================
// PURCHASE
// ==========================================
model Purchase {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  purchasedAt  DateTime @default(now())
  supplierName String?

  userId String
  user   User   @relation(fields: [userId], references: [id])

  totalCents Int
  notes      String?

  cancelledAt   DateTime?
  cancelledBy   String?
  cancelledUser User?     @relation("CancelledPurchases", fields: [cancelledBy], references: [id])

  items PurchaseItem[]

  @@index([accountId])
  @@index([accountId, purchasedAt])
  @@index([cancelledAt])
}

model PurchaseItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  purchaseId String
  purchase   Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  qty            Decimal @db.Decimal(10, 3)
  unitCostCents  Int
  discountPercentBp Int @default(0)
  netCostCents   Int @default(0)
  lineTotalCents Int
}

// ==========================================
// OPERATING EXPENSE
// ==========================================
model OperatingExpense {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  description String
  amountCents Int
  expenseDate DateTime @default(now())
  category    String?

  userId String
  user   User   @relation(fields: [userId], references: [id])

  notes String?

  @@index([accountId])
  @@index([accountId, expenseDate])
}

// ==========================================
// RETURN
// ==========================================
model Return {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  returnNumber Int
  returnCode   String // e.g. DEV-00001

  returnedAt DateTime @default(now())

  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  subtotalCents Int
  itbisCents    Int
  totalCents    Int

  notes String?

  cancelledAt   DateTime?
  cancelledBy   String?
  cancelledUser User?     @relation("CancelledReturns", fields: [cancelledBy], references: [id])

  items ReturnItem[]

  // returnNumber y returnCode únicos dentro del account
  @@unique([accountId, returnNumber])
  @@unique([accountId, returnCode])
  @@index([accountId])
  @@index([accountId, returnedAt])
  @@index([saleId])
  @@index([cancelledAt])
}

model ReturnItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  returnId String
  return   Return @relation(fields: [returnId], references: [id], onDelete: Cascade)

  saleItemId String
  saleItem   SaleItem @relation(fields: [saleItemId], references: [id])

  productId String
  product   Product @relation(fields: [productId], references: [id])

  qty Decimal @db.Decimal(10, 3)

  unitPriceCents Int
  lineTotalCents Int
}

// ==========================================
// QUOTE
// ==========================================
model Quote {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  quoteNumber Int
  quoteCode   String // e.g. COT-00001

  quotedAt DateTime @default(now())
  validUntil DateTime?

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  subtotalCents Int
  itbisCents    Int
  shippingCents Int @default(0)
  totalCents    Int

  notes String?

  items QuoteItem[]

  // quoteNumber y quoteCode únicos dentro del account
  @@unique([accountId, quoteNumber])
  @@unique([accountId, quoteCode])
  @@index([accountId])
  @@index([accountId, quotedAt])
  @@index([customerId])
  @@index([validUntil])
}

model QuoteItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  quoteId String
  quote   Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  qty Decimal @db.Decimal(10, 3)

  unitPriceCents     Int
  wasPriceOverridden Boolean @default(false)

  lineTotalCents Int
}

// ==========================================
// BANK ACCOUNTS (for DOP transfers)
// ==========================================
// Cuentas bancarias disponibles para transferencias
model BankAccount {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bankName      String  // Nombre del banco (ej: "Banco Popular Dominicano")
  accountType   String  // Tipo de cuenta (ej: "Cuenta de Ahorros", "Cuenta Corriente")
  accountNumber String  // Número de cuenta
  accountName   String  // Nombre del titular
  currency      String  @default("DOP") // Moneda de la cuenta

  // Información adicional opcional
  bankLogo      String? // URL del logo del banco
  instructions  String? // Instrucciones adicionales

  isActive      Boolean @default(true)
  displayOrder  Int     @default(0) // Para ordenar en la UI

  payments BillingPayment[]

  @@index([isActive, displayOrder])
}

// ==========================================
// BILLING SUBSCRIPTION
// ==========================================
// Estado de la suscripción de billing (1:1 con Account)
model BillingSubscription {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  status   BillingStatus   @default(TRIALING)
  currency BillingCurrency @default(DOP)
  provider BillingProvider @default(MANUAL)

  // Trial
  trialStartedAt DateTime?
  trialEndsAt    DateTime?

  // Período actual de facturación
  currentPeriodStartsAt DateTime?
  currentPeriodEndsAt   DateTime?

  // Período de gracia (3 días después del vencimiento)
  graceEndsAt DateTime?

  // Cambios pendientes para el próximo ciclo
  pendingCurrency BillingCurrency?
  pendingProvider BillingProvider?

  // Verificación manual (transferencias DOP)
  manualVerificationStatus ManualVerificationStatus @default(NONE)
  manualAccessGrantedAt    DateTime? // Cuando se subió el primer comprobante

  // Lemon Squeezy IDs
  lemonCustomerId     String?
  lemonSubscriptionId String?

  // Precios en centavos
  priceUsdCents Int @default(2000)  // $20.00 USD
  priceDopCents Int @default(130000) // RD$1,300 DOP (incluye impuestos)

  payments BillingPayment[]

  @@index([accountId])
  @@index([status])
  @@index([trialEndsAt])
  @@index([currentPeriodEndsAt])
  @@index([graceEndsAt])
}

// ==========================================
// BILLING PROFILE
// ==========================================
// Datos fiscales para recibos (1:1 con Account)
model BillingProfile {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  legalName String  // Nombre legal o razón social
  taxId     String  // Cédula o RNC
  address   String  // Dirección fiscal
  email     String  // Email para recibos
  phone     String? // Teléfono (opcional)

  @@index([accountId])
}

// ==========================================
// BILLING PAYMENT
// ==========================================
// Registro de pagos de billing
model BillingPayment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptionId String
  subscription   BillingSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  amountCents Int
  currency    BillingCurrency
  provider    BillingProvider

  status BillingPaymentStatus @default(PENDING)
  paidAt DateTime?
  rejectionReason String?

  // Para transferencias manuales
  reference     String? // Referencia de la transferencia
  bankAccountId String? // Cuenta bancaria elegida por el usuario
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id])

  // Para Lemon Squeezy
  externalId String? // ID de invoice/subscription en Lemon

  // Período que cubre este pago
  periodStartsAt DateTime?
  periodEndsAt   DateTime?

  proofs   BillingPaymentProof[]
  receipts BillingReceipt[]

  @@index([subscriptionId])
  @@index([status])
  @@index([createdAt])
  @@index([externalId])
  @@index([bankAccountId])
}

// ==========================================
// BILLING PAYMENT PROOF
// ==========================================
// Comprobantes de transferencia (0..n por pago)
model BillingPaymentProof {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  paymentId String
  payment   BillingPayment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  url         String   // URL del archivo en UploadThing
  uploadedAt  DateTime @default(now())
  amountCents Int?     // Monto del comprobante (opcional)
  note        String?  // Nota adicional

  @@index([paymentId])
}

// ==========================================
// BILLING RECEIPT
// ==========================================
// Recibos internos generados (sin NCF)
model BillingReceipt {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  paymentId String
  payment   BillingPayment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  receiptNumber String   @unique // Número de recibo interno (e.g., REC-00001)
  issuedAt      DateTime @default(now())
  emailSentAt   DateTime? // Cuando se envió por email

  // Snapshot de datos del perfil al momento de emisión
  legalName String
  taxId     String
  address   String

  @@index([paymentId])
  @@index([receiptNumber])
}

// ==========================================
// BILLING NOTIFICATION
// ==========================================
// Historial de notificaciones de billing enviadas
model BillingNotification {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  type    String  // trial_7, trial_3, due_3, due_1, grace_2, blocked, etc.
  channel String  // email, in_app
  sentAt  DateTime @default(now())

  // Metadata adicional
  metadata Json?

  @@index([accountId])
  @@index([accountId, type])
  @@index([sentAt])
}

// ==========================================
// SUPER ADMIN
// ==========================================

enum SuperAdminRole {
  OWNER    // Acceso total
  ADMIN    // Puede gestionar cuentas y pagos
  FINANCE  // Solo puede ver y aprobar pagos
  SUPPORT  // Solo puede ver información, no modificar
}

model SuperAdmin {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email        String         @unique
  name         String
  passwordHash String
  role         SuperAdminRole @default(SUPPORT)

  lastLoginAt DateTime?
  isActive    Boolean   @default(true)

  // Permisos granulares
  canManageAccounts  Boolean @default(false)
  canApprovePayments Boolean @default(false)
  canModifyPricing   Boolean @default(false)
  canSendEmails      Boolean @default(false)
  canDeleteAccounts  Boolean @default(false)
  canViewFinancials  Boolean @default(true)

  auditLogs SuperAdminAuditLog[]

  @@index([email])
  @@index([isActive])
}

// ==========================================
// SUPER ADMIN AUDIT LOG
// ==========================================
model SuperAdminAuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  superAdminId String
  superAdmin   SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: Cascade)

  action          String  // approved_payment, blocked_account, etc.
  targetAccountId String?
  targetPaymentId String?

  metadata  Json?
  ipAddress String?

  @@index([superAdminId])
  @@index([createdAt])
  @@index([action])
}

// ==========================================
// WHATSAPP OTP (legacy)
// ==========================================
model WhatsappOtp {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  phoneNumber String
  code        String
  expiresAt   DateTime
  consumedAt  DateTime?
  purpose     String
  attempts    Int    @default(0)
  ipAddress   String?
  userAgent   String?

  userId String?
  user   User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([phoneNumber, createdAt])
  @@index([phoneNumber, expiresAt])
  @@index([expiresAt])
}
